version: '3.8'

services:
  export-server:
    build: .
    expose:
      - "3001"
    environment:
      - NODE_ENV=production
      - PORT=3001
      - API_KEY=${API_KEY:?API_KEY is required in .env}
      - MAX_FILE_SIZE_MB=${MAX_FILE_SIZE_MB:-500}
      - ALLOWED_ORIGINS=${ALLOWED_ORIGINS:-https://tapedit.studio,https://www.tapedit.studio}
    volumes:
      - ./temp:/app/temp
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:3001/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    networks:
      - traefik-public
    labels:
      - "traefik.enable=true"
      # HTTP -> HTTPS redirect
      - "traefik.http.routers.tapedit-server.entrypoints=http"
      - "traefik.http.routers.tapedit-server.rule=Host(`api.tapedit.studio`)"
      - "traefik.http.middlewares.tapedit-https-redirect.redirectscheme.scheme=https"
      - "traefik.http.routers.tapedit-server.middlewares=tapedit-https-redirect"
      # HTTPS
      - "traefik.http.routers.tapedit-server-secure.entrypoints=https"
      - "traefik.http.routers.tapedit-server-secure.rule=Host(`api.tapedit.studio`)"
      - "traefik.http.routers.tapedit-server-secure.tls=true"
      - "traefik.http.routers.tapedit-server-secure.tls.certresolver=letsencrypt"
      - "traefik.http.services.tapedit-server.loadbalancer.server.port=3001"

networks:
  traefik-public:
    external: true
